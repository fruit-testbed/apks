# Contributor: "Herry <herry.herry@glasgow.ac.uk>"
# Maintainer: "Herry <herry.herry@glasgow.ac.uk>"
pkgname=p2p-update
pkgver=0.0.1
pkgrel=0
pkgdesc="P2P Update"
url="https://fruit-testbed.org"
arch="armhf"
license="Apache-2.0"
depends="musl fruit-keys"
depends_dev=""
makedepends="$depends_dev go upx"
install=""
subpackages=""
source="
${pkgname}-${pkgver}.zip::https://github.com/fruit-testbed/${pkgname}/archive/v${pkgver}.zip
config.json
"
options="suid !check"

prepare() {
	default_prepare
	mkdir -p $srcdir/src/github.com/fruit-testbed
	mv $srcdir/${pkgname}-${pkgver} $srcdir/src/github.com/fruit-testbed/${pkgname}
	GOPATH=$srcdir go get -u github.com/golang/dep/cmd/dep
	cd $srcdir/src/github.com/fruit-testbed/${pkgname}
	GOPATH=$srcdir $srcdir/bin/dep ensure
}

build() {
	cd $srcdir/src/github.com/fruit-testbed/${pkgname} \
		&& GOPATH=$srcdir go build -ldflags="-s -w" -o ${pkgname} *.go \
		&& upx ${pkgname} \

	return $?
}

package() {
	install -D -m755 -o root -g root \
		$srcdir/src/github.com/fruit-testbed/${pkgname}/${pkgname} \
		${pkgdir}/usr/sbin/${pkgname}

	install -D -m644 -o root -g root \
		$srcdir/config.json \
		${pkgdir}/etc/p2p-update/config.json

	return 0
}
sha512sums="0e6a6a70bb78170b8615b1dce348ea7d693b4a7848ac4d88350ce4dca90175fe1c8edeaf9b994f310e370997a1fdf7075ab039944077a2c4fca5c9b7137b3adc  p2p-update-0.0.1.zip
55e9118f67604e4b6df12bed433b925e76ef1ad88aa9bc62b04e0d84a53efffb92d8952f536e41b926da7158f5b7baf31824e9d747989f8c61125f3feb3381ad  config.json"
