# Maintainer: "Herry <herry.herry@glasgow.ac.uk>"
pkgname=fruit-u-boot
pkgver=2018.07
pkgver_suffix="-rc2"
pkgrel=10
pkgdesc="Das U-Boot"
url="http://www.denx.de/wiki/U-Boot"
arch="all"
_arch="$(apk --print-arch)"
license="GPL-2.0+"
depends=""
depends_dev=""
makedepends="$depends_dev gcc make dtc bc bison flex uboot-tools"
install=""
subpackages=""
source="u-boot-${pkgver}.zip::https://codeload.github.com/u-boot/u-boot/zip/v${pkgver}${pkgver_suffix}
boot.cmd.armhf
boot.cmd.aarch64
config.txt.armhf
config.txt.aarch64
"
options="suid !check"
builddir=$srcdir/u-boot-${pkgver}${pkgver_suffix}

prepare() {
	default_prepare
}

build() {
	cd "$builddir"

	# build u-boot
	case $_arch in
		armhf)
			# Raspberry Pi Zero W
			make rpi_0_w_defconfig \
				&& make -j4 \
				&& mv u-boot.bin u-boot-rpi0w.bin \
				|| return 1

			# Raspberry Pi 1
			make rpi_defconfig \
				&& make -j4 \
				&& mv u-boot.bin u-boot-rpi1.bin \
				|| return 1

			# Raspberry Pi 2
			make rpi_2_defconfig \
				&& make -j4 \
				&& mv u-boot.bin u-boot-rpi2.bin \
				|| return 1

			# Raspberry Pi 3 (32-bit)
			make rpi_3_32b_defconfig \
				&& make -j4 \
				&& mv u-boot.bin u-boot-rpi3.bin \
				|| return 1
			;;
		aarch64)
			# Raspberry Pi 3 (64-bit)
			make rpi_3_defconfig \
				&& make -j4 \
				|| return 1
			;;
	esac

	cd "$srcdir"
	mkimage -C none -A arm -T script -d boot.cmd.${_arch} boot.scr \
		|| return 1
}

package() {
	target=${pkgdir}/media/mmcblk0p1

	mkdir -p ${target}
	case $_arch in
		armhf)
			cp -a ${builddir}/u-boot-rpi*.bin ${target}/
			;;
		aarch64)
			cp -a ${builddir}/u-boot.bin ${target}/
			;;
	esac

	# install u-boot script
	install -m640 -o root -g root ${srcdir}/boot.scr ${target}/boot.scr

	# install config.txt
	install -m640 -o root -g root ${srcdir}/config.txt.${_arch} ${target}/config.txt
}
sha512sums="76aaa7e3cf149a5cae77f662011ba73e27edfdef57170ff1aab89305ea0a2b5782c372b64725328583be9418b7babd864ba8c62dac839dc4e3c97f00c3726a14  u-boot-2018.07.zip
473723ecf78e7a8778a90d980f070ef3f36b123840e16ffee53fbc2c1407a0acfbaff4e81ca6b532fe2d9592982b7c555b5e12fa7bd9cdafcd60b01c6769ce18  boot.cmd.aarch64
acef262ba32b2f94f4cdcbb53995961257ec9e35533a53b8e33922fb8f822fd5beea191bb2e0dc006a4561b13d701dedf78f447b7c316084af276765852b3172  boot.cmd.armhf
9c8b11782dfaa6f2421b5edbb1954778a6593730aaa024e8b1ec8778c9bfc0e76262bc6daa59f3f0afc3b5eaa2688947ee1aa212d46a7479ee966e581278b72a  config.txt.armhf
a75bbbda03840ec7c4d241df20fe6421967b2e67d79b9859f940d99524eaad83f3688f77a7d1cea98e76a89217cfbe1a842d5fcb50177ab39795be1e0aae0ebb  config.txt.aarch64"
