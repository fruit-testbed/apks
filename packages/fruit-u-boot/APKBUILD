# Maintainer: "Herry <herry.herry@glasgow.ac.uk>"
pkgname=fruit-u-boot
pkgver=2018.07
pkgver_suffix="-rc1"
pkgrel=0
pkgdesc="Das U-Boot"
url="http://www.denx.de/wiki/U-Boot"
arch="armhf"
license="GPL-2.0+"
depends=""
depends_dev=""
makedepends="$depends_dev gcc make dtc bc bison flex openssl-dev linux-headers sdl-dev"
install=""
subpackages=""
source="u-boot-${pkgver}.zip::https://codeload.github.com/u-boot/u-boot/zip/v${pkgver}${pkgver_suffix}
boot.cmd"
options="suid !check"
builddir=$srcdir/u-boot-${pkgver}${pkgver_suffix}

prepare() {
	default_prepare
}

build() {
	cd "$builddir"

	# build u-boot for rpi 0/1
	make rpi_defconfig \
		&& make -j2 \
		&& mv u-boot.bin u-boot-rpi.bin \
		|| return 1

	# build u-boot for rpi 2
	make rpi_2_defconfig \
		&& make -j2 \
		&& mv u-boot.bin u-boot-rpi2.bin \
		|| return 2

	# build u-boot for rpi 3
	make rpi_3_32b_defconfig \
		&& make -j2 \
		&& mv u-boot.bin u-boot-rpi3.bin \
		|| return 3

	cd "$srcdir"
	mkimage -C none -A arm -T script -d boot.cmd boot.scr \
		|| return 4

	# build tools
	cd "$builddir"
	make defconfig || return 5
	make tools-all || return 6
}

package() {
	target=${pkgdir}/media/mmcblk0p1

	mkdir -p ${target}

	# install u-boot binaries
	install -m750 -o root -g root ${builddir}/u-boot-rpi.bin ${target}/u-boot-rpi.bin
	install -m750 -o root -g root ${builddir}/u-boot-rpi2.bin ${target}/u-boot-rpi2.bin
	install -m750 -o root -g root ${builddir}/u-boot-rpi3.bin ${target}/u-boot-rpi3.bin

	# install u-boot script
	install -m640 -o root -g root ${srcdir}/boot.scr ${target}/boot.scr

	# create config.txt
	cat > ${target}/config.txt <<-EOL
		disable_splash=1
		boot_delay=0
		gpu_mem=256
		gpu_mem_256=64
		enable_uart=1
		[pi0]
		kernel=u-boot-rpi.bin
		[pi1]
		kernel=u-boot-rpi.bin
		[pi2]
		kernel=u-boot-rpi2.bin
		[pi3]
		kernel=u-boot-rpi3.bin
		[all]
		include usercfg.txt
	EOL

	# Install tools -- copied from APKBUILD of uboot-tools
	cd "$builddir"
	for tool in bmp_logo dumpimage easylogo/easylogo env/fw_printenv \
		fit_check_sign fit_info gdb/gdbcont gdb/gdbsend gen_eth_addr img2srec \
		mkenvimage mkimage ncb proftool ubsha1 xway-swap-bytes env/fw_printenv; do
			install -D tools/$tool \
				$pkgdir/usr/bin/$(basename $tool) || return 1
	done
	install -Dm644 tools/env/fw_env.config \
			$pkgdir/etc/fw_env.config || return 1
	cd "$pkgdir"/usr/bin
	ln -sf fw_printenv fw_setenv || return 1
}
sha512sums="e40cbeae0f2697dcb452c8240d11d1e3830ccc0dac2b6ebf41c41e9ea4dc1af0c00afb8f0eba2f5d72ab0c92e13ba85ea2f8d33d8672fd8ef0191353df66e58d  u-boot-2018.07.zip
367795c95532d3227917dd45bba62fa349f3bda368cf8173488e29d4faedefe00422efd83b60406ea2fc609d1c635674760c018dc4718c61f6815a98ab421293  boot.cmd"
